// Generated by CoffeeScript 1.6.3
(function() {
  var tooltips;

  tooltips = {
    currentNode: null,
    added: false,
    watching: [],
    after_click: 'Mocketed!',
    before_click: 'Mocket!',
    observe: function() {
      var _this = this;
      if (!this.observer) {
        return chrome.utils.observeDOM(document.body, [], function(obs) {
          _this.observer = obs;
          return _this.refresh();
        });
      }
    },
    start: function() {
      var closeCSS, closeNode, css, node,
        _this = this;
      chrome.utils.d.log('Tooltips START');
      if (chrome.utils.q('.mocket-tooltip')) {
        return;
      }
      node = document.createElement('div');
      css = {
        'text-align': 'center',
        'background': '#E7E7E7',
        'width': '100px',
        'position': 'absolute',
        'line-height': '20px',
        'z-index': 9999
      };
      node.className = 'mocket-tooltip';
      chrome.utils.setStyle(node, css);
      node.innerHTML = '<span style="color: #6D84B4;padding-right: 5px" class="mocket-add">Mocket!</span><a class="close"></a>';
      this.tooltip = node;
      this.tooltipAdd = node.querySelector('.mocket-add');
      closeNode = node.querySelector('.close');
      closeCSS = {
        'background-image': 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIAQMAAAD+wSzIAAAAA3NCSVQICAjb4U/gAAAABlBMVEX////dzHd5vQnAAAAAAnRSTlMA/1uRIrUAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAAAFUlEQVQImWM4zPCcoY7BBgjrgKzDACZQBMlbvpNAAAAAAElFTkSuQmCC)',
        'width': '8px',
        'height': '8px',
        'float': 'right',
        'margin': '6px 5px 7px 7px',
        'cursor': 'pointer'
      };
      chrome.utils.setStyle(closeNode, closeCSS);
      closeNode.addEventListener('click', function() {
        return _this.hide();
      });
      this.refresh();
      return this.observe();
    },
    refresh: function() {
      var node, nodes, nodesOfNodes, _i, _len, _results;
      nodesOfNodes = [];
      nodesOfNodes.push(chrome.utils.qa('[data-expanded-url^="http://www.youtu"'));
      nodesOfNodes.push(chrome.utils.qa('[data-expanded-url^="http://youtu"'));
      nodesOfNodes.push(chrome.utils.qa('[data-expanded-url^="http://spoti.fi"'));
      nodesOfNodes.push(chrome.utils.qa('[href^="http://youtu"'));
      _results = [];
      for (_i = 0, _len = nodesOfNodes.length; _i < _len; _i++) {
        nodes = nodesOfNodes[_i];
        _results.push((function() {
          var _j, _len1, _results1;
          _results1 = [];
          for (_j = 0, _len1 = nodes.length; _j < _len1; _j++) {
            node = nodes[_j];
            if (this.watching.indexOf(node) === -1) {
              this.bindHover(node);
              _results1.push(this.watching.push(node));
            } else {
              _results1.push(void 0);
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    },
    bindHover: function(node) {
      var _this = this;
      return node.addEventListener("click", function(e) {
        var $element, searchString;
        if (node !== _this.currentNode) {
          _this.currentNode = node;
          e.preventDefault();
          $element = e.target;
          searchString = node.getAttribute('data-expanded-url') || node.getAttribute('href');
          return _this.showTooltip(_this.getPos($element), searchString);
        }
      });
    },
    getPos: function(node) {
      var rect, scrollLeft, scrollTop, _x, _y;
      _x = 0;
      _y = 0;
      rect = node.getBoundingClientRect();
      scrollTop = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop;
      scrollLeft = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft;
      _y = rect.top + scrollTop;
      _x = rect.left + scrollLeft;
      return {
        top: _y,
        left: _x
      };
    },
    showTooltip: function(pos, searchString) {
      var offsetTop,
        _this = this;
      this.addTooltip();
      offsetTop = 20;
      this.tooltip.style.display = 'block';
      this.tooltip.style.top = pos.top - offsetTop + "px";
      this.tooltip.style.left = pos.left + "px";
      if (chrome.archive.search(searchString)) {
        this.tooltipAdd.removeAttribute('data-searchstring');
        this.tooltipAdd.innerText = this.after_click;
        this.tooltipAdd.style.cursor = "initial";
        return setTimeout(function() {
          return _this.hide();
        }, 5000);
      } else {
        this.tooltipAdd.innerText = this.before_click;
        this.tooltipAdd.setAttribute('data-searchstring', searchString);
        return this.tooltipAdd.style.cursor = "pointer";
      }
    },
    hide: function() {
      this.currentNode = null;
      return this.tooltip.style.display = 'none';
    },
    addTooltip: function() {
      var _this = this;
      if (!this.added) {
        this.added = true;
        chrome.utils.q('body').appendChild(this.tooltip);
        return chrome.utils.on('click', this.tooltipAdd, function(evt) {
          var search;
          evt.preventDefault();
          if (!(search = _this.tooltipAdd.getAttribute('data-searchstring'))) {
            return;
          }
          _this.tooltipAdd.removeAttribute('data-searchstring');
          _this.tooltipAdd.innerText = _this.after_click;
          _this.tooltipAdd.style.cursor = "initial";
          setTimeout(function() {
            return _this.hide();
          }, 5000);
          chrome.archive.push(search);
          return chrome.runtime.sendMessage({
            method: "postSong",
            data: {
              search: search
            }
          });
        });
      }
    },
    inHistory: function(string, callback) {
      return chrome.runtime.sendMessage({
        method: "searchHistory",
        data: string
      }, callback);
    }
  };

  chrome.utils.d.log('toolips');

  tooltips.start();

}).call(this);
