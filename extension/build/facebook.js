// Generated by CoffeeScript 1.6.3
(function() {
  var facebook;

  facebook = {
    start: function() {
      var _this = this;
      chrome.utils.d.log('FB START');
      chrome.utils.observeDOM(document.querySelector('body'), function() {
        return _this.refresh();
      });
      return this.refresh();
    },
    refresh: function() {
      var action, element, end, i, link, node, nodes, start, _i, _results;
      chrome.utils.d.log('Facebook refresh');
      nodes = document.getElementsByClassName('mainWrapper');
      start = 0;
      end = nodes.length - 1;
      _results = [];
      for (i = _i = start; start <= end ? _i <= end : _i >= end; i = start <= end ? ++_i : --_i) {
        node = nodes[i];
        if (!this.alreadyAdded(node)) {
          element = this.getSpotify(node) || this.getYoutube(node);
          if (element) {
            action = node.getElementsByClassName('UIActionLinks')[0];
            action.insertAdjacentHTML('beforeend', '<a class="mocketLink" data-searchstring="' + escape(element) + '">Mocket It!</a> Â·');
            link = node.getElementsByClassName('mocketLink')[0];
            _results.push(chrome.utils.on('click', link, function(evt) {
              var after_click, e, search;
              evt.preventDefault();
              after_click = 'Mocketed!';
              e = evt.toElement;
              if (e.innerText === after_click) {
                return;
              }
              search = e.getAttribute('data-searchstring');
              e.innerText = after_click;
              return chrome.runtime.sendMessage({
                method: "postSong",
                data: {
                  search: search
                }
              });
            }));
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    },
    alreadyAdded: function(obj) {
      var done, not_yet;
      done = obj.innerHTML.match('Mocket It');
      not_yet = obj.innerHTML.match('Mocketed!');
      return done && done.length > 0 || not_yet && not_yet.length > 0;
    },
    getSpotify: function(obj) {
      var v;
      if (obj instanceof Node) {
        v = obj.getElementsByClassName('featured_song')[0];
        if (v) {
          return v.innerText;
        }
      }
      return null;
    },
    getYoutube: function(obj) {
      var e, match, regexp, string;
      regexp = /youtube\.\S*/ig;
      string = '';
      if (obj instanceof Node) {
        string = obj.innerText;
      }
      match = string.match(regexp);
      if (match && match.length > 0) {
        e = obj.getElementsByClassName('uiAttachmentTitle')[0];
        if (e) {
          return e.innerText;
        }
      }
      return null;
    }
  };

  chrome.utils.d.log('Facebook');

  facebook.start();

}).call(this);
